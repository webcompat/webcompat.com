# Need to use "trusty" for Java 1.8
# ref: https://blog.travis-ci.com/2015-10-14-opening-up-ubuntu-trusty-beta/
sudo: required
dist: trusty

language: python

python:
  - "2.7"

# cache pip and npm package installations
cache:
  pip: true
  directories:
    - node_modules

# limit the depth of the commits we clone
git:
  depth: 5

env:
  global:
    - ISSUES_REPO_URI=webcompat/webcompat-tests/issues
    - FAKE_ID=e80a666fbf1fa9ea18db
    - FAKE_SECRET=688c4546f09624f8c44773b22268064dfca19a59
    # grab latest 4.x release, which is LTS for now
    - TRAVIS_NODE_VERSION="4"
    - username:
      secure: "wdMST3NlymxcrnDJlH3PAv5q4Tm8jCyJxQhQs9wJ/dOc36uubJeiCISWahNHEOCLVySrII9M+yZSJETFhvk/nSf7VePqejyLjNkmfDE6Qob92RmMNPGdId4Ktq1EMNi6fELxRDKXiAHPe4X5GReCUm/uzrIs0VcdQ9IK1uZpxMfcmw12UZiMPxpomBjWkbGyZy9BlS49ezcaTuMdpHhCxfpiclxPpJIxsR/VkpAIUsrd/CHj7nybEaf2RjmyKcNA/1xjde6TmyYqooHOmOXAR2s2PHm+8HqD8VuDl5ZNaoDNB27yIUUkNVjFvHVvEP8qXRRNoBS02RQYK6ms1u8dApT6ac7mN7xJTG5rfQPjf41ZMBUsePqwul3X1ADso9YvlaEe39dgET1xFLwIbXBLR78tCcMRgAieNSsf7Cd0/PX8me/iamKsR499SmE96sHSWAO89dHzqeeXbdZnSy4su4p6r1+199NWir1totEJY9ym0x/7x7g9y0eMytvDRTOtopwFJGtFhOJkFB2ssEUd4cD1At2POUegWlV9oXwJgqCFKdXqRNVaPJT0RooR9f3lgVPceX/yXd9Tgo7N4qihZADr3ynwOAvhiJVqZyapT1GUjPYNB1nldbET35BUsdZyjfO1DVBc28RZCN9Uxfa4DN4h9xTwYOe5U7C0m+jLGao="
    - access_key:
      secure: "JgymAwFINs9GbCRhOQPmwPj05RsPioLX55cEqHWDQMSAeLe1md5sMP8LIMA7QKT8TIJbxvy6/sR6n7yXnbGL+R09OOY99nl0e3Mf/0gmR2k3GROn5+q3NvXDYeNy9M9Rt9C7eQ6qX2SY9s8HohppIJtna69wsrUu2oAaPUg0CjkrDNucEDS9S6SDlpfY4oDxisLvx2i6tlntsPmkL+/FaxMs/jCjTZ0AVPwcCnL/N+ls+jLC3zHlhPyrwtQCoyMkbdIOM9WA3Vs0el1GjDTThsdhCcgC7SciXHaizOt7z/MCufbmYOVEtxeCHn2s3xCSpb4uVOMqzsmtQDGE7M7J7aLQ7gJRax9VAs0oq3dCKaOJiazURZa7G6qrJG9s7teOjUj6h11ymIeQWJCGXoaAR/yxXfPns/DCzT3yBUr5kkqxPBI4ZBiEIfD7hjv9uQQ0/za76NTvAFP22VWWeHuOub20tYeNb/zpPDVkGqiyMraPwUXub3akezIMZkxg9YiKytLBVEcx28xur0l1xli+Jq3Gj1wXbtCwo5d6F4tciSDVowXEQZVbkBl481KyC7JzWrpW7gKvGSOhr5lXPOtfDxgmgjMVF+mhOoBNYNOJ8FzTRacfSsdR9Y1DfGujS3JeP7L7RPR5eYvsCha3QpaTyOnmXuVVARGIOBrrnDIq6iE="

addons:
  firefox: "50.1.0"
  browserstack:
    username: username
    access_key: access_key
    forcelocal: true
    #only: localhost,5000,0
    proxyHost: "http://localhost"
    proxyPort: "5000"

before_install:
  - "export DISPLAY=:99.0"
  - "sh -e /etc/init.d/xvfb start"

install:
  - rm -rf ~/.nvm && git clone https://github.com/creationix/nvm.git ~/.nvm && (cd ~/.nvm && git checkout `git describe --abbrev=0 --tags`) && source ~/.nvm/nvm.sh && nvm install $TRAVIS_NODE_VERSION
  - travis_retry npm install -g grunt-cli
  - travis_retry npm install
  - travis_retry npm run pip
  - travis_retry npm run config
  - which firefox
  - java -version
  - firefox --version
  # lint python
  - pep8 --ignore=E402 webcompat/ tests/ config/secrets.py.example
  - npm run module
  - python run.py -t &

before_script:
  - "sleep 2"
  # lint JS in default eslint task
  - npm run lint
  - npm run build

# now run the tests!
# if this is a pull request from a fork, TRAVIS_SECURE_ENV_VARS will be false, so
# just run the non-auth tests. otherwise, run everything.
script:
  - nosetests
  - if [ "$TRAVIS_SECURE_ENV_VARS" == "false" ] ; then node_modules/.bin/intern-runner config=tests/browserstack_remote BROWSERSTACK_USERNAME="$BROWSERSTACK_USERNAME" BROWSERSTACK_ACCESS_KEY="$BROWSERSTACK_ACCESS_KEY" reporters=Console functionalSuites=tests/functional-nonauth ; fi
  - if [ "$TRAVIS_SECURE_ENV_VARS" == "true" ] ; then node_modules/.bin/intern-runner config=tests/intern reporters=Console user="$USER" pw="$PW" ; fi
